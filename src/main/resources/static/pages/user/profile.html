<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>用户中心 - 订单管理系统</title>
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.6.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/main.css">
    <style>
        .profile-container {
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            background-color: #fff;
        }
        .profile-header {
            text-align: center;
            margin-bottom: 30px;
        }
        .avatar-container {
            text-align: center;
            margin-bottom: 20px;
        }
        .avatar-img {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #f8f9fa;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        .avatar-upload {
            margin-top: 10px;
        }
        .form-section {
            margin-top: 30px;
        }
    </style>
</head>
<body>
    <div class="container mt-3">
        <a href="javascript:history.back()" class="btn btn-outline-secondary mb-3">
            <i class="fas fa-arrow-left"></i> 返回上一页
        </a>
    </div>

    <div class="container profile-container">
        <div class="profile-header">
            <h2>个人中心</h2>
            <p class="text-muted">管理您的个人信息</p>
        </div>
        
        <div class="alert alert-success" id="success-message" style="display: none;"></div>
        <div class="alert alert-danger" id="error-message" style="display: none;"></div>
        
        <div class="row">
            <div class="col-md-4">
                <div class="avatar-container">
                    <img src="/images/default-avatar.jpg" alt="用户头像" class="avatar-img" id="avatar-preview">
                    <div class="avatar-upload mt-3">
                        <form id="avatar-form" enctype="multipart/form-data">
                            <div class="custom-file">
                                <input type="file" class="custom-file-input" id="avatar-upload" accept="image/*">
                                <label class="custom-file-label" for="avatar-upload">选择图片</label>
                            </div>
                            <button type="button" class="btn btn-primary btn-block mt-2" id="upload-avatar-btn">确认上传</button>
                        </form>
                    </div>
                </div>
            </div>
            <div class="col-md-8">
                <div class="form-section">
                    <h4>个人信息</h4>
                    <form id="profile-form">
                        <div class="form-group">
                            <label for="username">用户名</label>
                            <input type="text" class="form-control" id="username" readonly>
                        </div>
                        <div class="form-group">
                            <label for="realName">真实姓名</label>
                            <input type="text" class="form-control" id="realName">
                        </div>
                        <div class="form-group">
                            <label for="email">电子邮箱</label>
                            <input type="email" class="form-control" id="email">
                        </div>
                        <div class="form-group">
                            <label for="phone">手机号码</label>
                            <input type="tel" class="form-control" id="phone">
                        </div>
                        <div class="form-group">
                            <label for="address">地址</label>
                            <textarea class="form-control" id="address" rows="3"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">保存修改</button>
                    </form>
                </div>
                
                <div class="form-section mt-4">
                    <h4>修改密码</h4>
                    <form id="password-form">
                        <div class="form-group">
                            <label for="currentPassword">当前密码</label>
                            <input type="password" class="form-control" id="currentPassword" required>
                        </div>
                        <div class="form-group">
                            <label for="newPassword">新密码</label>
                            <input type="password" class="form-control" id="newPassword" required pattern="^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]{6,18}$">
                            <small class="form-text text-muted">密码长度6-18位，需包含字母和数字</small>
                        </div>
                        <div class="form-group">
                            <label for="confirmPassword">确认新密码</label>
                            <input type="password" class="form-control" id="confirmPassword" required>
                        </div>
                        <button type="submit" class="btn btn-warning">修改密码</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/popper.js/1.16.1/umd/popper.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.6.0/js/bootstrap.min.js"></script>
    <script src="/js/main.js"></script>
    <script>
        $(document).ready(function() {
            // 检查用户是否已登录
            checkLoginStatus().then(function(isLoggedIn) {
                if (isLoggedIn) {
                    // 加载用户信息
                    loadUserProfile();
                    
                    // 绑定退出登录事件
                    $('#logout-btn').click(function(e) {
                        e.preventDefault();
                        logout();
                    });
                    
                    // 绑定个人信息表单提交事件
                    $('#profile-form').submit(function(e) {
                        e.preventDefault();
                        updateProfile();
                    });
                    
                    // 绑定修改密码表单提交事件
                    $('#password-form').submit(function(e) {
                        e.preventDefault();
                        changePassword();
                    });
                    
                    // 绑定头像上传事件
                    $('#avatar-upload').change(function() {
                        previewAvatar(this);
                    });
                    
                    $('#upload-avatar-btn').click(uploadAvatar);
                }
            });
        });
        
        // 加载用户头像
        function loadUserProfile() {
            fetchAPI('/api/users/current')
                .then(user => {
                    // 填充表单数据
                    $('#username').val(user.username);
                    $('#realName').val(user.realName || '');
                    $('#email').val(user.email || '');
                    $('#phone').val(user.phone || '');
                    $('#address').val(user.address || '');

                    // 默认设置头像路径为静态资源路径
                    const defaultAvatarPath = '/images/default-avatar.jpg';
                    $('#avatar-preview').attr('src', defaultAvatarPath);

                    // 显示用户头像 - 从 BLOB 端点加载
                    // 确保API路径与后端一致
                    const avatarUrl = `/api/users/avatar/${user.userId}`;
                    const token = localStorage.getItem('token'); // 获取Token
                    fetch(avatarUrl, {
                        headers: {
                            'Authorization': `Bearer ${token}` // 添加Authorization Header
                        }
                    })
                        .then(response => {
                            if (response.ok) {
                                return response.blob();
                            } else if (response.status === 404) {
                                // 如果头像数据不存在，返回默认头像路径
                                return Promise.resolve(new Blob([], { type: 'image/jpg' }));
                            } else {
                                throw new Error('Failed to load avatar');
                            }
                        })
                        .then(blob => {
                            if (blob.size === 0) {
                                // 如果返回的是空 Blob，说明是默认头像路径，直接使用默认路径
                                $('#avatar-preview').attr('src', defaultAvatarPath);
                            } else {
                                const objectURL = URL.createObjectURL(blob);
                                $('#avatar-preview').attr('src', objectURL); // 动态更新头像路径
                            }
                        })
                        .catch(error => {
                            console.warn('Failed to load avatar, using default:', error);
                            // 保持默认头像路径不变
                            $('#avatar-preview').attr('src', defaultAvatarPath);
                        });

                    // 显示用户名
                    $('.username-display').text("当前登录用户：" + user.username);
                })
                .catch(error => {
                    console.error('加载用户信息失败:', error);
                    showErrorMessage('加载用户信息失败: ' + error.message);
                });
        }
        
        // 更新个人信息
        async function updateProfile() {
            const userData = {
                realName: $('#realName').val(),
                email: $('#email').val(),
                phone: $('#phone').val(),
                address: $('#address').val()
            };
            
            try {
                await fetchAPI('/api/users/profile/update', {
                    method: 'PUT',
                    body: JSON.stringify(userData)
                });
                
                showSuccessMessage('个人信息更新成功');
            } catch (error) {
                console.error('更新个人信息失败:', error);
                showErrorMessage('更新个人信息失败: ' + error.message);
            }
        }
        
        // 修改密码
        async function changePassword() {
            const currentPassword = $('#currentPassword').val();
            const newPassword = $('#newPassword').val();
            const confirmPassword = $('#confirmPassword').val();
            
            // 验证新密码
            if (newPassword !== confirmPassword) {
                showErrorMessage('两次输入的新密码不一致');
                return;
            }
            
            // 验证密码格式 (前端)
            const passwordPattern = /^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]{6,18}$/;
            if (!passwordPattern.test(newPassword)) {
                showErrorMessage('新密码格式不正确：长度6-18位，需包含字母和数字');
                return;
            }

            try {
                await fetchAPI('/api/users/change-password', {
                    method: 'PUT',
                    body: JSON.stringify({
                        currentPassword: currentPassword,
                        newPassword: newPassword
                    })
                });
                
                // 清空表单
                $('#password-form')[0].reset();
                
                showSuccessMessage('密码修改成功');
            } catch (error) {
                console.error('修改密码失败:', error);
                showErrorMessage('修改密码失败: ' + error.message);
            }
        }
        
        // 预览头像
        function previewAvatar(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    $('#avatar-preview').attr('src', e.target.result);
                }
                
                reader.readAsDataURL(input.files[0]);
                
                // 更新文件选择框的标签
                const fileName = input.files[0].name;
                $(input).next('.custom-file-label').html(fileName);
            }
        }
        
        // 上传头像
        async function uploadAvatar() {
            const fileInput = $('#avatar-upload')[0];
            if (!fileInput.files || fileInput.files.length === 0) {
                showErrorMessage('请先选择图片');
                return;
            }
            
            const formData = new FormData();
            formData.append('avatar', fileInput.files[0]);
            
            try {
                const token = localStorage.getItem('token');
                // 确保API路径与后端一致
                const response = await fetch('/api/users/avatar/upload', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`上传失败: ${response.status}`);
                }

                // No JSON response expected, just success message
                // Reload profile to show the new avatar
                showSuccessMessage('头像上传成功');
                loadUserProfile(); // Reload user profile to display the new avatar
            } catch (error) {
                console.error('上传头像失败:', error);
                showErrorMessage('上传头像失败: ' + error.message);
            }
        }
    </script>
</body>
</html>